name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  id-token: write  # Required for PyPI trusted publishing

jobs:
  release:
    runs-on: ubuntu-latest
    concurrency: release
    outputs:
      new_release: ${{ steps.release.outputs.new_release }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install python-semantic-release
        run: pip install python-semantic-release

      - name: Python Semantic Release
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Run semantic-release which handles version bump, commit, tag, and GitHub release
          semantic-release version

          # Check if a new version was created
          if git diff --name-only HEAD~1 | grep -q "pyproject.toml"; then
            echo "new_release=true" >> $GITHUB_OUTPUT
          else
            echo "new_release=false" >> $GITHUB_OUTPUT
          fi

          # Push changes if any were made
          git push origin main --tags || true

      - name: Build package
        if: steps.release.outputs.new_release == 'true'
        run: |
          pip install build
          python -m build

      - name: Publish to PyPI
        if: steps.release.outputs.new_release == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        # Uses trusted publishing - no token needed
        # Configure at: https://pypi.org/manage/account/publishing/

  update-homebrew:
    needs: release
    if: needs.release.outputs.new_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Get PyPI package info
        id: pypi
        run: |
          # Retry loop â€” PyPI may take a moment to serve the new version
          for i in 1 2 3 4 5 6; do
            sleep 15
            VERSION=$(curl -s https://pypi.org/pypi/clipsy/json | jq -r .info.version)
            RESPONSE=$(curl -s "https://pypi.org/pypi/clipsy/${VERSION}/json")
            URL=$(echo "$RESPONSE" | jq -r '.urls[] | select(.packagetype == "sdist") | .url')
            SHA256=$(echo "$RESPONSE" | jq -r '.urls[] | select(.packagetype == "sdist") | .digests.sha256')

            if [ -n "$URL" ] && [ "$URL" != "null" ]; then
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "url=$URL" >> $GITHUB_OUTPUT
              echo "sha256=$SHA256" >> $GITHUB_OUTPUT
              echo "Found clipsy ${VERSION} on PyPI"
              exit 0
            fi
            echo "Waiting for PyPI... (attempt $i)"
          done
          echo "::error::Failed to get PyPI package info after retries"
          exit 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Update Homebrew formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          PYPI_URL: ${{ steps.pypi.outputs.url }}
          PYPI_SHA256: ${{ steps.pypi.outputs.sha256 }}
          NEW_VERSION: ${{ steps.pypi.outputs.version }}
        run: |
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/brencon/homebrew-clipsy.git"
          cd homebrew-clipsy

          python3 << 'EOF'
          import os, re

          url = os.environ["PYPI_URL"]
          sha256 = os.environ["PYPI_SHA256"]

          with open("Formula/clipsy.rb") as f:
              content = f.read()

          # Replace the clipsy package URL (first url in the file, not resource URLs)
          content = re.sub(
              r'url "https://files\.pythonhosted\.org/packages/[^"]+"',
              f'url "{url}"',
              content,
              count=1,
          )

          # Replace the clipsy package SHA256 (first sha256 in the file, not resource hashes)
          content = re.sub(
              r'sha256 "[a-f0-9]{64}"',
              f'sha256 "{sha256}"',
              content,
              count=1,
          )

          with open("Formula/clipsy.rb", "w") as f:
              f.write(content)
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/clipsy.rb
          git diff --staged --quiet || (git commit -m "Update clipsy to ${NEW_VERSION}" && git push)
